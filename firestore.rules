// prefinal
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.email == 'mikefernandex227@gmail.com';
    }

    function isExistingDoc() {
      return resource != null;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    // This function is key for public creation.
    // It allows creation if the user is authenticated (which they will be, via anonymous auth)
    // and their senderId matches their UID. This prevents spoofing.
    function isSenderOnCreate() {
        return isSignedIn() && request.auth.uid == request.resource.data.senderId;
    }

    function isFeedbackSenderOnCreate() {
        return !('senderId' in request.resource.data) || request.auth.uid == request.resource.data.senderId;
    }

    function isExistingSender() {
      return isSignedIn() && isExistingDoc() && request.auth.uid == resource.data.senderId;
    }

    match /users/{userId} {
      allow read, write: if isOwner(userId);
      allow list: if false;
    }

    // The recipients collection is managed by the backend (or in this case, not at all by clients).
    // It is read-only for clients. The app will fall back to querying messages directly.
    match /recipients/{recipientId} {
      allow get, list: if true;
      allow write: if false; // CRITICAL: Prevent client-side modification.
    }

    // Public messages, creatable by any authenticated (including anonymous) user.
    match /public_messages/{messageId} {
      allow get, list: if true;

      // Allow creation if the sender is valid (authenticated user matching their own UID)
      // and the document ID is being set correctly.
      allow create: if isSenderOnCreate() && request.resource.data.id == messageId;

      // Only the original sender (if they were logged in) can update their message.
      allow update: if isExistingSender() && request.resource.data.senderId == resource.data.senderId;

      // Only the original sender or an admin can delete.
      allow delete: if isExistingSender() || isAdmin();
    }

    match /feedback/{feedbackId} {
      allow get, list, update, delete: if isAdmin();
      // Allow feedback from signed-in users for accountability.
      allow create: if isSignedIn() && isFeedbackSenderOnCreate();
    }

    match /visits/{visitId} {
        allow get, list, update, delete: if isAdmin();
        // Allow anyone to create a visit record for analytics.
        allow create: if true;
    }

    match /reviews/{reviewId} {
        allow get, list: if true;
        allow create: if isSenderOnCreate();
        allow update, delete: if isAdmin() || isExistingSender();
    }
  }
}
