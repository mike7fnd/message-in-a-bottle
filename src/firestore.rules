// prefinal
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // Ensure this email is secured and not easily guessable
      return isSignedIn() && request.auth.token.email == 'mikefernandex227@gmail.com';
    }

    function isExistingDoc() {
      return resource != null;
    }

    function isNewDoc() {
        return resource == null;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    // This function is key for public creation.
    // It allows creation if the user is authenticated (which they will be, via anonymous auth)
    // and their senderId matches their UID. This prevents spoofing.
    function isSenderValidOnCreate() {
        // Allow if senderId is not provided (truly anonymous) or if it matches the user's UID
        return isSignedIn() && (!('senderId' in request.resource.data) || request.resource.data.senderId == request.auth.uid);
    }

    function isFeedbackSenderOnCreate() {
        return !('senderId' in request.resource.data) || request.auth.uid == request.resource.data.senderId;
    }

    function isExistingSender() {
      return isSignedIn() && isExistingDoc() && request.auth.uid == resource.data.senderId;
    }

    function isUpdatingAllowedFields() {
        // Users can only update the 'content' and 'timestamp' fields.
        return request.resource.data.keys().hasAll(['content', 'timestamp']) && request.resource.data.keys().size() == 2;
    }

    // User-specific rules (for potential future features)
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      allow list: if false;
    }

    // The recipients collection is managed by the backend (or in this case, not at all by clients).
    // It is read-only for clients to ensure data integrity.
    match /recipients/{recipientId} {
      allow get, list: if true;
      allow write: if false; // CRITICAL: Prevent client-side modification.
    }

    // Public messages, creatable by any authenticated (including anonymous) user.
    match /public_messages/{messageId} {
      allow get, list: if true;

      // Allow creation if the sender is valid (authenticated user matching their own UID)
      // and the document ID is being set correctly.
      allow create: if isSenderValidOnCreate() && request.resource.data.id == messageId;

      // Only the original sender can update their message, and only specific fields.
      allow update: if isExistingSender() && isUpdatingAllowedFields();

      // Only the original sender or an admin can delete.
      allow delete: if isExistingSender() || isAdmin();
    }

    match /feedback/{feedbackId} {
      allow get, list, update, delete: if isAdmin();
      // Allow feedback from signed-in users for accountability.
      allow create: if isSignedIn() && isFeedbackSenderOnCreate();
    }

    match /visits/{visitId} {
        allow get, list, update, delete: if isAdmin();
        // Allow anyone to create a visit record for analytics.
        allow create: if true;
    }
  }
}
