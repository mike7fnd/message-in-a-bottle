
{
  "entities": {
    "Message": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Message",
      "type": "object",
      "description": "Represents a message sent in a bottle.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the message."
        },
        "senderId": {
          "type": "string",
          "description": "Reference to Sender. (Relationship: Sender 1:N Message)"
        },
        "recipientId": {
          "type": "string",
          "description": "Reference to Recipient. (Relationship: Recipient 1:N Message)"
        },
        "content": {
          "type": "string",
          "description": "The content of the message."
        },
        "timestamp": {
          "type": "string",
          "description": "The timestamp when the message was sent.",
          "format": "date-time"
        },
        "photo": {
          "type": "string",
          "description": "A data URL of the photo or sketch attached to the message."
        },
        "spotifyTrackId": {
            "type": "string",
            "description": "The Spotify track ID for the song attached to the message."
        }
      },
      "required": [
        "id",
        "senderId",
        "recipientId",
        "content",
        "timestamp"
      ]
    },
    "Sender": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Sender",
      "type": "object",
      "description": "Represents the sender of a message.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the sender."
        },
        "name": {
          "type": "string",
          "description": "The name of the sender (can be anonymous)."
        }
      },
      "required": [
        "id"
      ]
    },
    "Recipient": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Recipient",
      "type": "object",
      "description": "Represents the recipient of a message, with aggregated data.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the recipient (lowercase name)."
        },
        "name": {
          "type": "string",
          "description": "The name of the recipient."
        },
        "messageCount": {
          "type": "number",
          "description": "The total number of messages for this recipient."
        },
        "lastMessageTimestamp": {
          "type": "string",
          "format": "date-time",
          "description": "The timestamp of the most recent message."
        }
      },
      "required": [
        "id",
        "name",
        "messageCount",
        "lastMessageTimestamp"
      ]
    },
    "Feedback": {
      "title": "Feedback",
      "type": "object",
      "description": "Represents user feedback for the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the feedback."
        },
        "content": {
          "type": "string",
          "description": "The main content of the feedback."
        },
        "type": {
          "type": "string",
          "description": "The type of feedback (e.g., 'suggestion', 'bug', 'other').",
          "enum": ["suggestion", "bug", "other"]
        },
        "senderId": {
            "type": "string",
            "description": "The UID of the user who submitted the feedback (if logged in)."
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "The timestamp when the feedback was submitted."
        }
      },
      "required": ["id", "content", "type", "timestamp"]
    },
    "Visit": {
      "title": "Visit",
      "type": "object",
      "description": "Represents a single visit to the application for analytics.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the visit."
        },
        "country": {
          "type": "string",
          "description": "The country of the visitor."
        },
        "city": {
          "type": "string",
          "description": "The city of the visitor."
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "The timestamp of the visit."
        }
      },
      "required": ["id", "country", "city", "timestamp"]
    },
    "Review": {
        "title": "Review",
        "type": "object",
        "description": "Represents a public user review and rating for the application.",
        "properties": {
            "id": {
                "type": "string",
                "description": "Unique identifier for the review."
            },
            "rating": {
                "type": "number",
                "description": "The star rating given by the user (1-5)."
            },
            "content": {
                "type": "string",
                "description": "The content of the user's review."
            },
            "senderId": {
                "type": "string",
                "description": "The UID of the user who submitted the review."
            },
            "senderName": {
                "type": "string",
                "description": "The display name of the user, or 'Anonymous'."
            },
            "timestamp": {
                "type": "string",
                "format": "date-time",
                "description": "The timestamp when the review was submitted."
            }
        },
        "required": ["id", "rating", "content", "senderId", "senderName", "timestamp"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous",
      "google"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}/messages/{messageId}",
        "definition": {
          "entityName": "Message",
          "schema": {
            "$ref": "#/backend/entities/Message"
          },
          "description": "Stores messages for a specific user. Uses path-based ownership for simple security rules. senderId and recipientId are stored for quick referencing.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user who owns the message."
            },
            {
              "name": "messageId",
              "description": "The ID of the message."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "Sender",
          "schema": {
            "$ref": "#/backend/entities/Sender"
          },
          "description": "Stores sender profiles.  Allows user details to be retrieved easily without querying all messages.",
          "params": [
            {
              "name": "userId",
              "description": "The ID of the user."
            }
          ]
        }
      },
      {
        "path": "/recipients/{recipientId}",
        "definition": {
          "entityName": "Recipient",
          "schema": {
            "$ref": "#/backend/entities/Recipient"
          },
          "description": "Stores recipient summary data for fast reads on the browse page. Denormalized data.",
          "params": [
            {
              "name": "recipientId",
              "description": "The ID of the recipient."
            }
          ]
        }
      },
      {
        "path": "/public_messages/{messageId}",
        "definition": {
          "entityName": "Message",
          "schema": {
            "$ref": "#/backend/entities/Message"
          },
          "description": "Stores public, anonymous messages for the 'browse bottles' feature.",
          "params": [
            {
              "name": "messageId",
              "description": "The ID of the public message."
            }
          ]
        }
      },
      {
        "path": "/feedback/{feedbackId}",
        "definition": {
          "entityName": "Feedback",
          "schema": {
            "$ref": "#/backend/entities/Feedback"
          },
          "description": "Stores user feedback. Writable by any authenticated user, readable only by admins.",
          "params": [
            {
              "name": "feedbackId",
              "description": "The ID of the feedback entry."
            }
          ]
        }
      },
      {
        "path": "/visits/{visitId}",
        "definition": {
          "entityName": "Visit",
          "schema": {
            "$ref": "#/backend/entities/Visit"
          },
          "description": "Stores visitor location data for analytics. Writable by anyone, readable only by admins.",
          "params": [
            {
              "name": "visitId",
              "description": "The ID of the visit entry."
            }
          ]
        }
      },
      {
        "path": "/reviews/{reviewId}",
        "definition": {
          "entityName": "Review",
          "schema": {
            "$ref": "#/backend/entities/Review"
          },
          "description": "Stores public user reviews. Writable by any authenticated user, readable by anyone.",
          "params": [
            {
              "name": "reviewId",
              "description": "The ID of the review entry."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the 'Message in a Bottle' application, focusing on secure and efficient message storage and retrieval. It adheres to the principle of Authorization Independence by denormalizing necessary authorization data. The structure also supports the required QAPs by segregating data based on ownership and access patterns.\n\nMessages are stored within user-specific subcollections to maintain ownership and simplify security rules. A 'public_messages' collection allows for browsing 'bottles' without direct user association, enhancing the anonymous aspect of the app. A 'feedback' collection is added to allow users to submit feedback, which is only readable by admins. A 'visits' collection is added to track visitor analytics. A 'recipients' collection is added to denormalize data for faster reads on the browse page. A 'reviews' collection is added to store public user reviews, which are readable by anyone.\n\nThe structure leverages path-based ownership for user-specific data (messages) and separate collections for public, summary, and review data, ensuring clarity and predictable authorization rules.\n\nAuthorization Independence: The 'public_messages', 'recipients', and 'reviews' collections allow for anonymous browsing without requiring any `get()` calls to other documents.\nQAPs: Secure `list` operations are enabled by the separation of user-owned messages and public messages."
  }
}
